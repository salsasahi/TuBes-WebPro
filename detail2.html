<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Konfirmasi Pemesanan</title>
    <link rel="stylesheet" href="style-detail2.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      .btn-pesan:disabled { background-color: #ccc; cursor: not-allowed; }
      .loading-spinner {
        display: inline-block; width: 1rem; height: 1rem;
        border: 2px solid #fff; border-radius: 50%;
        border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <header class="navbar">
      <div class="back-section" style="cursor: pointer;" onclick="window.history.back()">
        <i class="bi bi-arrow-left"></i>
        <span>Detail Event</span>
      </div>
      <nav class="nav-links">
        <a href="dashboard_new.html">Dashboard</a>
        <a href="profilnew.html">My Events</a>
        <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" alt="User" class="avatar" />
      </nav>
    </header>

    <main class="container">
      <section class="card">
        <div class="section-header">
          <h1>Konfirmasi Pemesanan</h1>
          <h2 id="eventName">Nama Event</h2>
          <div class="event-location" id="eventLocationDisplay">
            <strong>Location</strong><br />Address<br /><span class="ticket-info">-</span>
          </div>
        </div>

        <hr class="divider" />

        <div class="event-date-section">
          <h3>Tanggal Event</h3>
          <p class="event-date" id="eventDateDisplay">-</p>
          <ul class="event-notes">
            <li><i class="bi bi-x-circle-fill"></i><span>Tidak bisa refund</span></li>
            <li><i class="bi bi-square"></i><span>Tempat duduk bebas</span></li>
          </ul>
        </div>

        <hr class="divider" />

        <div class="form-section">
          <h3>Detail Pemesanan</h3>
          <form id="bookingForm">
            <div class="form-group">
              <label>Nama Lengkap</label>
              <input type="text" id="inputName" placeholder="Nama Lengkap" required />
            </div>
            <div class="form-group">
              <label>Nomor Handphone</label>
              <input type="tel" id="inputPhone" placeholder="Nomor Handphone" required />
            </div>
            <div class="form-group">
              <label>Jenis Kelamin</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="gender" value="Laki-Laki" checked />
                  <span>Laki-Laki</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="gender" value="Perempuan" />
                  <span>Perempuan</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>Alamat Email</label>
              <input type="email" id="inputEmail" placeholder="Alamat Email" required />
            </div>
          </form>
        </div>

        <hr class="divider" />

        <div class="price-section">
          <h3>Detail Harga</h3>
          <div class="price-item" id="ticket-price-item">
            <span>Tiket x (Pax)</span><span>IDR 0</span>
          </div>
          <div class="price-item">
            <span>Biaya Layanan</span><span>IDR 2.000</span>
          </div>
          <hr class="price-divider" />
          <div class="total">
            <span>Total Pembayaran</span><span class="total-amount" id="totalAmountDisplay">IDR 0</span>
          </div>
        </div>

        <button class="btn-pesan" id="submitBtn">Pesan</button>
      </section>
    </main>

    <script>
      const API_BASE_URL = 'http://127.0.0.1:8000';
      const token = localStorage.getItem('authToken');
      const userDataStr = localStorage.getItem('userData');

      document.addEventListener('DOMContentLoaded', function() {
        if (!token) {
          alert("Anda harus login untuk memesan.");
          window.location.href = "login.html";
          return;
        }

        // Prefill Form dari Data User Login
        if (userDataStr) {
            try {
                const user = JSON.parse(userDataStr);
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=random`;
                if(user.username) document.getElementById('inputName').value = user.username;
                if(user.email) document.getElementById('inputEmail').value = user.email;
            } catch (e) {}
        }

        // Ambil Data Event dari LocalStorage (Diset saat klik di Dashboard)
        const orderDataStr = localStorage.getItem('orderData');
        if (!orderDataStr) {
            alert("Data pemesanan tidak ditemukan.");
            window.location.href = "dashboard_new.html";
            return;
        }

        const data = JSON.parse(orderDataStr);
        renderOrderDetails(data);

        // Listener Tombol Pesan
        document.getElementById('submitBtn').addEventListener('click', function(e) {
            e.preventDefault();
            submitBooking(data);
        });
      });

      function renderOrderDetails(data) {
          document.getElementById('eventName').textContent = data.eventName;
          document.getElementById('eventLocationDisplay').innerHTML = `
            <strong>${data.location}</strong><br />${data.address || ''}<br />
            <span class="ticket-info">${data.quantity} Tiket â€¢ Pax ${data.quantity}</span>
          `;
          document.getElementById('eventDateDisplay').textContent = data.date;
          
          const totalPriceTickets = data.pricePerTicket * data.quantity;
          document.getElementById('ticket-price-item').innerHTML = `
            <span>Tiket ${data.quantity} (Pax)</span>
            <span>IDR ${totalPriceTickets.toLocaleString('id-ID')}</span>
          `;
          
          const totalWithFee = totalPriceTickets + 2000;
          document.getElementById('totalAmountDisplay').textContent = `IDR ${totalWithFee.toLocaleString('id-ID')}`;
      }

      // --- LOGIKA UTAMA FETCHING API (2 STEP) ---
      async function submitBooking(orderData) {
          const btn = document.getElementById('submitBtn');
          const nama = document.getElementById('inputName').value.trim();
          const telp = document.getElementById('inputPhone').value.trim();
          const email = document.getElementById('inputEmail').value.trim();
          const gender = document.querySelector('input[name="gender"]:checked').value;

          if (!nama || !telp || !email) {
            alert('Mohon lengkapi semua data!');
            return;
          }

          // Payload disesuaikan dengan BookingController Laravel Anda
          const payload = {
              event_id: parseInt(orderData.eventId),
              quantity: parseInt(orderData.quantity),
              customer_name: nama,
              customer_phone: telp,
              customer_email: email,
              gender: gender // Value: "Laki-Laki" atau "Perempuan"
          };

          try {
              // 1. UI Loading State
              btn.disabled = true;
              btn.innerHTML = `<span class="loading-spinner"></span> Membuat Pesanan...`;

              // 2. Request PERTAMA: Buat Booking (POST /api/bookings)
              const response = await fetch(`${API_BASE_URL}/api/bookings`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json',
                      'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(payload)
              });

              const result = await response.json();

              if (!response.ok) {
                  // Handle Error Validasi dari Laravel
                  let errMsg = result.message || "Gagal membuat pesanan.";
                  if (result.errors) {
                      errMsg += "\n" + Object.values(result.errors).map(e => `- ${e[0]}`).join("\n");
                  }
                  throw new Error(errMsg);
              }

              // Ambil ID Booking dari response
              const bookingId = result.data?.id || result.data?.booking?.id;
              
              if (!bookingId) {
                  throw new Error("ID Booking tidak ditemukan. Cek respon server.");
              }

              // 3. Request KEDUA: Minta Link Bayar (POST /api/bookings/{id}/pay)
              btn.innerHTML = `<span class="loading-spinner"></span> Menyiapkan Pembayaran...`;
              
              const payResponse = await fetch(`${API_BASE_URL}/api/bookings/${bookingId}/pay`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json',
                      'Authorization': `Bearer ${token}`
                  }
              });

              const payResult = await payResponse.json();

              if (!payResponse.ok) {
                  throw new Error(payResult.message || "Gagal request ke Midtrans.");
              }

              // 4. Ambil Link & Redirect
              let paymentUrl = null;
              if (payResult.links && payResult.links.redirect_to_payment) {
                  paymentUrl = payResult.links.redirect_to_payment;
              } else if (payResult.data && payResult.data.transaction && payResult.data.transaction.payment_url) {
                  paymentUrl = payResult.data.transaction.payment_url;
              }

              if (paymentUrl) {
                  alert(`Pesanan berhasil! Mengarahkan ke pembayaran...`);
                  localStorage.removeItem('orderData'); // Bersihkan cart
                  window.location.href = paymentUrl;    // Redirect ke Midtrans
              } else {
                  throw new Error("Link pembayaran tidak ditemukan.");
              }

          } catch (error) {
              alert(error.message);
              console.error(error);
          } finally {
              // Reset Tombol
              btn.disabled = false;
              btn.innerHTML = 'Pesan';
          }
      }
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | EventKu Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="eo.css" />
  <style>
    /* Tambahan CSS untuk loading state */
    .loading-row { text-align: center; padding: 20px; }
  </style>
</head>
<body>

  <div class="d-flex">
    <aside class="sidebar d-flex flex-column justify-content-between p-3">
      <div>
        <h5 class="text-white fw-bold mb-4"><i class="bi bi-calendar-event me-2"></i>Event Admin</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2">
            <a href="eo.html" class="nav-link active text-white"><i class="bi bi-house-door me-2"></i>Dashboard</a>
          </li>
          </ul>
      </div>

      <div class="admin-info text-white-50 small">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <img src="https://ui-avatars.com/api/?name=Admin&background=random" class="rounded-circle me-2" alt="Admin" style="width: 35px; height: 35px; object-fit: cover;" id="adminAvatar">
            <div>
              <p class="mb-0 text-white fw-semibold" id="adminNameDisplay">Admin User</p>
              <small id="adminEmailDisplay">admin@eventku.com</small>
            </div>
          </div>
          <button class="btn btn-sm btn-outline-light ms-2" data-bs-toggle="modal" data-bs-target="#logoutModal" title="Logout">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </div>
      </div>
    </aside>

    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel"><i class="bi bi-box-arrow-right me-2"></i>Konfirmasi Logout</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Apakah Anda yakin ingin keluar dari dashboard admin?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-danger" id="confirmLogout"><i class="bi bi-box-arrow-right me-1"></i>Logout</button>
          </div>
        </div>
      </div>
    </div>

    <main class="main-content flex-grow-1 p-4 bg-light">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h5 class="fw-semibold">Dashboard Overview</h5>
          <p class="text-muted small mb-0">Welcome back! Here's what's happening with your events.</p>
        </div>
        <a href="tambah-event.html"><button class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> New Event</button> </a>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Total Events</h6>
              <h3 class="fw-bold" id="statTotalEvents">-</h3>
              <p class="text-success small mb-0"><i class="bi bi-calendar-check"></i> Recorded events</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Total Participants</h6>
              <h3 class="fw-bold" id="statTotalParticipants">-</h3>
              <p class="text-success small mb-0"><i class="bi bi-people"></i> Across all events</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Active Events</h6>
              <h3 class="fw-bold" id="statActiveEvents">-</h3>
              <p class="text-info small mb-0"><i class="bi bi-lightning"></i> Running now</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h6 class="text-muted">Draft Events</h6>
              <h3 class="fw-bold" id="statDraftEvents">-</h3>
              <p class="text-warning small mb-0"><i class="bi bi-pencil"></i> Not published</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-semibold mb-0">Recent Events</h6>
            <div class="input-group w-auto">
              <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search events..." />
              <button class="btn btn-sm btn-outline-secondary" id="btnSearch"><i class="bi bi-search"></i></button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr class="text-muted small">
                  <th>Event</th>
                  <th>Date</th>
                  <th>Participants</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="eventsTableBody">
                <tr>
                    <td colspan="5" class="loading-row"><div class="spinner-border text-primary" role="status"></div> Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted" id="showingText">Showing events</small>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><button class="page-link" id="prevPage">Previous</button></li>
                <li class="page-item disabled"><span class="page-link" id="currentPage">1</span></li>
                <li class="page-item"><button class="page-link" id="nextPage">Next</button></li>
              </ul>
            </nav>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- KONFIGURASI API ---
    const API_BASE_URL = 'http://127.0.0.1:8000';
    const token = localStorage.getItem('authToken');
    const userDataStr = localStorage.getItem('userData');
    let currentPage = 1;
    let lastPage = 1;

    // --- CEK AUTH ---
    if (!token) {
        window.location.href = 'login.html';
    }

    // --- LOAD USER INFO ---
    if (userDataStr) {
        try {
            const user = JSON.parse(userDataStr);
            document.getElementById('adminNameDisplay').textContent = user.username || 'Admin';
            document.getElementById('adminEmailDisplay').textContent = user.email || 'admin@eventku.com';
            document.getElementById('adminAvatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=random`;
        } catch (e) { console.error(e); }
    }

    // --- 1. FETCH STATS ---
    async function fetchStats() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/events/stats`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                const data = result.data || result; // Sesuaikan dengan struktur response backend

                // Asumsi backend mengembalikan field berikut. Jika tidak, sesuaikan key-nya.
                document.getElementById('statTotalEvents').textContent = data.total_events || 0;
                document.getElementById('statTotalParticipants').textContent = data.total_participants || 0;
                document.getElementById('statActiveEvents').textContent = data.active_events || 0;
                // Ganti revenue dengan Draft atau data lain jika API revenue tidak ada
                document.getElementById('statDraftEvents').textContent = data.draft_events || 0;
            }
        } catch (error) {
            console.error("Gagal mengambil stats:", error);
        }
    }

    // --- 2. FETCH EVENTS LIST ---
    async function fetchEvents(page = 1, search = '') {
        const tableBody = document.getElementById('eventsTableBody');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3"><div class="spinner-border text-primary" role="status"></div></td></tr>`;

        try {
            const params = new URLSearchParams({
                page: page,
                per_page: 5, // Tampilkan 5 per halaman agar rapi
                search: search
            });

            const response = await fetch(`${API_BASE_URL}/api/events?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                handleLogout(); // Token expired
                return;
            }

            const result = await response.json();
            
            // Handle struktur pagination Laravel
            let events = [];
            if (result.data && result.data.data) {
                events = result.data.data;
                currentPage = result.data.current_page;
                lastPage = result.data.last_page;
            } else if (result.data) {
                events = result.data;
            }

            renderTable(events);
            updatePaginationUI();

        } catch (error) {
            console.error("Error fetching events:", error);
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Gagal memuat data. Periksa koneksi server.</td></tr>`;
        }
    }

    // --- RENDER TABLE ---
    function renderTable(events) {
        const tableBody = document.getElementById('eventsTableBody');
        tableBody.innerHTML = '';

        if (events.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tidak ada event ditemukan.</td></tr>`;
            return;
        }

        events.forEach(event => {
            const categoryName = event.category ? event.category.name : 'Uncategorized';
            const dateStr = new Date(event.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Badge Status Logic
            let badgeClass = 'bg-secondary';
            if (event.status === 'published') badgeClass = 'bg-success';
            if (event.status === 'draft') badgeClass = 'bg-warning text-dark';
            if (event.status === 'completed') badgeClass = 'bg-dark';

            const row = `
                <tr>
                  <td>
                    <div>
                      <h6 class="mb-0 fw-semibold">${event.title}</h6>
                      <small class="text-muted">${categoryName}</small>
                    </div>
                  </td>
                  <td>${dateStr}</td>
                  <td>${event.current_participants || 0}/${event.max_participants || 'Unl'}</td>
                  <td><span class="badge ${badgeClass}">${event.status}</span></td>
                  <td>
                    <a href="edit-event.html?id=${event.id}" class="text-decoration-none" title="Edit">
                      <i class="bi bi-pencil-square text-primary me-2"></i>
                    </a>
                    <a href="#" onclick="deleteEvent(${event.id})" class="text-decoration-none" title="Delete">
                        <i class="bi bi-trash text-danger"></i>
                    </a>
                  </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    // --- 3. DELETE EVENT ---
    window.deleteEvent = async (id) => {
        if (!confirm("Apakah Anda yakin ingin menghapus event ini?")) return;

        try {
            const response = await fetch(`${API_BASE_URL}/api/events/${id}`, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                alert("Event berhasil dihapus");
                fetchEvents(currentPage); // Refresh data
                fetchStats(); // Refresh stats juga
            } else {
                alert("Gagal menghapus event");
            }
        } catch (error) {
            console.error("Error deleting:", error);
            alert("Terjadi kesalahan.");
        }
    };

    // --- 4. LOGOUT ---
    document.getElementById('confirmLogout').addEventListener('click', async function() {
        try {
            await fetch(`${API_BASE_URL}/api/logout`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
        } catch (e) { console.log(e); }
        
        localStorage.clear();
        window.location.href = 'login.html';
    });

    // --- PAGINATION & SEARCH ---
    function updatePaginationUI() {
        document.getElementById('currentPage').innerText = currentPage;
        document.getElementById('prevPage').parentElement.classList.toggle('disabled', currentPage <= 1);
        document.getElementById('nextPage').parentElement.classList.toggle('disabled', currentPage >= lastPage);
    }

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) fetchEvents(currentPage - 1, document.getElementById('searchInput').value);
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < lastPage) fetchEvents(currentPage + 1, document.getElementById('searchInput').value);
    });

    document.getElementById('btnSearch').addEventListener('click', () => {
        fetchEvents(1, document.getElementById('searchInput').value);
    });

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchStats();
        fetchEvents();
    });
  </script>
</body>
</html>
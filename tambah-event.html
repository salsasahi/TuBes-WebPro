<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tambah Event Baru | EventKu Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="tambah-event.css">
  <style>
    .upload-box {
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-box:hover {
      border-color: #4A90E2;
      background: #f0f7ff;
    }

    .upload-box.dragover {
      border-color: #4A90E2;
      background: #e8f4fc;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .admin-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9ca3af, #6b7280);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
    }

    .form-section {
      border-bottom: 1px solid #eee;
      padding-bottom: 25px;
      margin-bottom: 25px;
    }

    .form-section:last-of-type {
      border-bottom: none;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      flex-direction: column;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .error-alert {
      display: none;
    }

    .error-alert.show {
      display: block;
    }

    .remove-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 12px;
    }

    .preview-container {
      position: relative;
      display: inline-block;
    }
  </style>
</head>

<body class="bg-light">

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner-border text-light mb-3" role="status"></div>
    <p id="loadingText">Menyimpan event...</p>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-light bg-white shadow-sm px-4">
    <a class="navbar-brand d-flex align-items-center" href="eo.html">
      <i class="bi bi-calendar-event fs-4 text-primary me-2"></i>
      <span class="fw-semibold">EventKu Admin</span>
    </a>
    <div class="d-flex align-items-center">
      <div class="d-flex align-items-center">
        <div class="admin-avatar me-2">
          <i class="bi bi-person"></i>
        </div>
        <span class="fw-medium" id="adminName">Admin</span>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="eo.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="eo.html">Events</a></li>
        <li class="breadcrumb-item active" aria-current="page">Tambah Event</li>
      </ol>
    </nav>

    <!-- Title -->
    <div class="mb-4">
      <h3 class="fw-semibold">Tambah Event Baru</h3>
      <p class="text-muted">Isi form di bawah untuk menambahkan event baru ke dalam sistem</p>
    </div>

    <!-- Error Alert -->
    <div class="alert alert-danger error-alert" id="errorAlert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span id="errorMessage">Terjadi kesalahan</span>
    </div>

    <!-- Card Form -->
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <form id="eventForm" enctype="multipart/form-data">

          <!-- Informasi Dasar -->
          <div class="form-section">
            <h6 class="fw-semibold mb-3"><i class="bi bi-info-circle me-2"></i>Informasi Dasar</h6>
            <p class="text-muted small">Masukkan informasi dasar tentang event</p>

            <div class="mb-3">
              <label class="form-label fw-medium">Nama Event <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="title" name="title" placeholder="Masukkan judul event"
                required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Deskripsi Event</label>
              <textarea class="form-control" id="description" name="description" rows="4"
                placeholder="Masukkan deskripsi lengkap event"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Apa yang Akan Didapat Peserta</label>
              <textarea class="form-control" id="what_you_will_get" name="what_you_will_get" rows="3"
                placeholder="Contoh: Sertifikat, Materi Workshop, Snack, dll"></textarea>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Kategori Event <span class="text-danger">*</span></label>
                <select class="form-select" id="category_id" name="category_id" required>
                  <option value="" selected disabled>Pilih kategori event</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Status</label>
                <select class="form-select" id="status" name="status">
                  <option value="draft">Draft</option>
                  <option value="published" selected>Published</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Tanggal & Lokasi -->
          <div class="form-section">
            <h6 class="fw-semibold mb-3"><i class="bi bi-calendar-event me-2"></i>Tanggal & Lokasi</h6>
            <p class="text-muted small">Tentukan waktu dan tempat pelaksanaan event</p>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Tanggal & Waktu Mulai <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" id="start_date" name="start_date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Tanggal & Waktu Selesai <span class="text-danger">*</span></label>
                <input type="datetime-local" class="form-control" id="end_date" name="end_date" required>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Lokasi Event <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="location" name="location"
                placeholder="Contoh: Jakarta Convention Center" required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Alamat Lengkap</label>
              <input type="text" class="form-control" id="address" name="address"
                placeholder="Contoh: Jl. Gatot Subroto No.1, Jakarta">
            </div>
          </div>

          <!-- Harga & Kuota -->
          <div class="form-section">
            <h6 class="fw-semibold mb-3"><i class="bi bi-cash me-2"></i>Harga & Kuota</h6>
            <p class="text-muted small">Tentukan harga tiket dan jumlah maksimal peserta</p>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Harga Tiket (IDR)</label>
                <input type="number" class="form-control" id="price" name="price" placeholder="0 untuk gratis" min="0"
                  value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-medium">Kuota Peserta <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="max_participants" name="max_participants"
                  placeholder="Masukkan jumlah maksimal peserta" min="1" required>
              </div>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured">
              <label class="form-check-label" for="is_featured">
                Jadikan event ini sebagai <strong>Featured Event</strong>
              </label>
            </div>
          </div>

          <!-- Upload Gambar -->
          <div class="form-section">
            <h6 class="fw-semibold mb-3"><i class="bi bi-image me-2"></i>Gambar Event</h6>
            <p class="text-muted small">Upload gambar untuk mempromosikan event (PNG, JPG, JPEG, GIF - max 2MB)</p>

            <div class="upload-box text-center p-5" id="uploadBox">
              <i class="bi bi-cloud-arrow-up fs-1 text-secondary mb-3" id="uploadIcon"></i>
              <p class="text-muted mb-2" id="uploadText">Drag & drop gambar di sini atau</p>
              <label class="text-primary fw-semibold" style="cursor: pointer;">
                Pilih File
                <input type="file" class="d-none" id="imageInput" name="image"
                  accept="image/jpeg,image/png,image/jpg,image/gif">
              </label>
              <p class="text-muted small mt-2">PNG, JPG, JPEG, GIF (max 2MB)</p>

              <div class="preview-container" id="previewContainer" style="display: none;">
                <img id="imagePreview" class="image-preview" src="" alt="Preview">
                <button type="button" class="remove-image-btn" id="removeImageBtn" title="Hapus gambar">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label fw-medium">Atau masukkan URL Gambar</label>
              <input type="url" class="form-control" id="image_url" name="image_url"
                placeholder="https://example.com/image.jpg">
              <small class="text-muted">Jika mengupload file, URL gambar akan diabaikan</small>
            </div>
          </div>

          <!-- Buttons -->
          <div class="d-flex justify-content-end gap-2 pt-3">
            <a href="eo.html" class="btn btn-outline-secondary">
              <i class="bi bi-x-lg me-1"></i> Batal
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="bi bi-save me-2"></i> Simpan Event
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================================================
    // KONFIGURASI API
    // ==================================================
    const API_BASE_URL = 'http://127.0.0.1:8000';

    // ==================================================
    // CEK AUTENTIKASI
    // ==================================================
    const token = localStorage.getItem('authToken');
    const userDataStr = localStorage.getItem('userData');

    if (!token) {
      alert("Sesi habis atau belum login. Silakan login kembali.");
      window.location.href = "login.html";
    }

    // Update admin name
    if (userDataStr) {
      try {
        const userData = JSON.parse(userDataStr);
        document.getElementById('adminName').textContent = userData.username || 'Admin';
      } catch (e) {
        console.error("Error parsing user data:", e);
      }
    }

    // ==================================================
    // ELEMEN DOM
    // ==================================================
    const eventForm = document.getElementById('eventForm');
    const categorySelect = document.getElementById('category_id');
    const imageInput = document.getElementById('imageInput');
    const uploadBox = document.getElementById('uploadBox');
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadText = document.getElementById('uploadText');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');

    let selectedFile = null;

    // ==================================================
    // FUNGSI HELPER
    // ==================================================
    function showLoading(text = "Menyimpan event...") {
      loadingText.textContent = text;
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.add('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideError() {
      errorAlert.classList.remove('show');
    }

    // ==================================================
    // FETCH CATEGORIES
    // Endpoint: GET /api/categories
    // ==================================================
    async function fetchCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/categories`, {
          headers: { 'Accept': 'application/json' }
        });

        const result = await response.json();
        console.log("Categories Response:", result);

        if (result.success && result.data && result.data.categories) {
          result.data.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error("Error fetching categories:", error);
      }
    }

    // ==================================================
    // IMAGE UPLOAD HANDLING
    // ==================================================
    function handleFileSelect(file) {
      if (!file) return;

      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        showError('Tipe file tidak valid. Hanya JPEG, PNG, JPG, dan GIF yang diperbolehkan.');
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showError('Ukuran file terlalu besar. Maksimal 2MB.');
        return;
      }

      selectedFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function (e) {
        imagePreview.src = e.target.result;
        previewContainer.style.display = 'inline-block';
        uploadIcon.style.display = 'none';
        uploadText.style.display = 'none';
      };
      reader.readAsDataURL(file);

      hideError();
    }

    // File input change
    imageInput.addEventListener('change', function (e) {
      if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
      }
    });

    // Remove image button
    removeImageBtn.addEventListener('click', function (e) {
      e.stopPropagation();
      selectedFile = null;
      imageInput.value = '';
      imagePreview.src = '';
      previewContainer.style.display = 'none';
      uploadIcon.style.display = 'block';
      uploadText.style.display = 'block';
    });

    // Drag and drop
    uploadBox.addEventListener('dragover', function (e) {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });

    uploadBox.addEventListener('dragleave', function (e) {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
    });

    uploadBox.addEventListener('drop', function (e) {
      e.preventDefault();
      uploadBox.classList.remove('dragover');

      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    // ==================================================
    // SUBMIT FORM - CREATE EVENT
    // Endpoint: POST /api/events
    // ==================================================
    eventForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      hideError();

      // Validate required fields
      const title = document.getElementById('title').value.trim();
      const category_id = document.getElementById('category_id').value;
      const start_date = document.getElementById('start_date').value;
      const end_date = document.getElementById('end_date').value;
      const location = document.getElementById('location').value.trim();
      const max_participants = document.getElementById('max_participants').value;

      if (!title || !category_id || !start_date || !end_date || !location || !max_participants) {
        showError('Mohon lengkapi semua field yang wajib diisi (*)');
        return;
      }

      // Validate dates
      if (new Date(end_date) < new Date(start_date)) {
        showError('Tanggal selesai harus setelah atau sama dengan tanggal mulai');
        return;
      }

      showLoading('Menyimpan event...');

      try {
        // Build FormData
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', document.getElementById('description').value || '');
        formData.append('what_you_will_get', document.getElementById('what_you_will_get').value || '');
        formData.append('category_id', category_id);
        formData.append('start_date', start_date);
        formData.append('end_date', end_date);
        formData.append('location', location);
        formData.append('address', document.getElementById('address').value || '');
        formData.append('price', document.getElementById('price').value || 0);
        formData.append('max_participants', max_participants);
        formData.append('status', document.getElementById('status').value);
        formData.append('is_featured', document.getElementById('is_featured').checked ? 1 : 0);

        // Add image file if selected
        if (selectedFile) {
          formData.append('image', selectedFile);
        } else {
          // Use image URL if no file selected
          const imageUrl = document.getElementById('image_url').value.trim();
          if (imageUrl) {
            formData.append('image_url', imageUrl);
          }
        }

        console.log("Submitting event...");

        const response = await fetch(`${API_BASE_URL}/api/events`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        // Handle unauthorized
        if (response.status === 401) {
          localStorage.clear();
          alert("Sesi Anda telah berakhir. Silakan login kembali.");
          window.location.href = "login.html";
          return;
        }

        const result = await response.json();
        console.log("Create Event Response:", result);

        if (response.ok && (result.success || result.data)) {
          hideLoading();
          alert('Event berhasil ditambahkan!');
          window.location.href = 'eo.html';
        } else {
          hideLoading();

          // Handle validation errors
          if (result.errors) {
            const errorMessages = Object.values(result.errors).flat().join('\n');
            showError(errorMessages);
          } else {
            showError(result.message || 'Gagal menyimpan event');
          }
        }

      } catch (error) {
        console.error("Create Event Error:", error);
        hideLoading();
        showError(`Terjadi kesalahan: ${error.message}`);
      }
    });

    // ==================================================
    // INIT
    // ==================================================
    document.addEventListener('DOMContentLoaded', function () {
      fetchCategories();
    });
  </script>

</body>

</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - EventKu</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Tambahan style untuk loading dan error state */
    .loading { text-align: center; padding: 40px; font-size: 1.2rem; color: #666; width: 100%; }
    .error-msg { text-align: center; width: 100%; padding: 20px; color: #dc3545; background: #f8d7da; border-radius: 8px; }
    .user-menu { display: flex; align-items: center; gap: 15px; }
    .btn-logout { background: none; border: 1px solid #dc3545; color: #dc3545; padding: 5px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
    .btn-logout:hover { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-left">
      <img src="logoEvent.jpg" alt="EventKu" class="logo-icon" onerror="this.style.display='none'"/> 
      <h1 class="logo-text">EventKu</h1>
    </div>
    <nav class="navbar-links">
      <a href="dashboard_new.html" class="active">Beranda</a>
      <a href="#events">Event</a>
      <a href="#about">Tentang</a>
      <a href="#contact">Kontak</a>
    </nav>
    <div class="navbar-right">
      <div class="user-menu">
        <span id="userNameDisplay" style="font-weight: 600; color: #333;">Hi, User</span>
        <a href="profilnew.html" class="user-avatar">
          <img id="userAvatarImg" src="https://ui-avatars.com/api/?name=User&background=random" alt="User" />
        </a>
        <button onclick="handleLogout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-text">
      <h1>Temukan Event <span> Terbaik</span> di EventKu</h1>
      <p>Platform terpercaya untuk menemukan dan mengikuti berbagai event menarik. Dari seminar bisnis hingga konser musik, semuanya ada di sini.</p>
      <div class="hero-buttons">
        <a href="#events" class="btn-primary">Lihat Event</a>
      </div>
    </div>
    <div class="hero-img">
      <img src="img.jpg" alt="Event Image" onerror="this.src='https://via.placeholder.com/600x400?text=EventKu+Hero'"/>
    </div>
  </section>

  <section class="search">
    <h2>Cari Event Favoritmu</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Cari nama event..." />
      
      <select id="categorySelect">
        <option value="">Semua Kategori</option>
        </select>
      
      <button id="searchBtn"><i class="fas fa-search"></i> Cari</button>
    </div>
  </section>

  <section id="events" class="featured">
    <h2>Event Terbaru</h2>
    <p>Jangan lewatkan event-event terbaik bulan ini!</p>

    <div class="event-list" id="eventListContainer">
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Memuat event...</div>
    </div>
  </section>

  <section id="about" class="about-section-centered">
    <div class="about-content">
      <span class="sub-title">Tentang Kami</span>
      <h2>Platform Event <span>Terlengkap</span></h2>
      <p>
        EventKu hadir sebagai solusi digital terdepan untuk menghubungkan penyelenggara acara dengan audiens yang tepat. 
        Kami berkomitmen memberikan pengalaman mencari, mengikuti, dan mengelola berbagai jenis event secara mudah, 
        aman, dan menyenangkan bagi semua orang di seluruh Indonesia.
      </p>
      
      <div class="about-stats-mini">
        <div class="stat-item">
          <strong>100%</strong>
          <span>Aman & Terpercaya</span>
        </div>
        <div class="stat-item">
          <strong>24/7</strong>
          <span>Dukungan Pelanggan</span>
        </div>
      </div>
    </div>
  </section>

  <footer id="contact" class="main-footer">
    <div class="footer-container">
      <div class="footer-info">
        <h3 class="footer-logo">EventKu</h3>
        <p>Platform terpercaya untuk menemukan dan mengelola event impianmu dengan mudah dan aman.</p>
        <div class="social-icons">
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-facebook"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-linkedin"></i></a>
        </div>
      </div>

      <div class="footer-links">
        <h3>Navigasi</h3>
        <ul>
          <li><a href="dashboard_new.html">Beranda</a></li>
          <li><a href="#events">Cari Event</a></li>
          <li><a href="#about">Tentang Kami</a></li>
          <li><a href="#contact">Kontak</a></li>
        </ul>
      </div>

      <div class="footer-contact">
        <h3>Hubungi Kami</h3>
        <a href="mailto:support@eventku.com" class="contact-item">
          <i class="fas fa-envelope"></i>support@eventku.com
        </a>
        <a href="tel:+6281234567890" class="contact-item">
          <i class="fas fa-phone-alt"></i>+62 812 3456 7890
        </a>
        <p class="contact-item">
          <i class="fas fa-map-marker-alt"></i> Jakarta, Indonesia
        </p>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p class="copyright">Â© 2024 <strong>EventKu</strong>. Semua hak cipta dilindungi.</p>
    </div>
  </footer>

  <script>
    // --- KONFIGURASI API ---
    const API_BASE_URL = 'http://127.0.0.1:8000'; // Sesuaikan port backend Anda
    
    // --- CEK LOGIN & USER DATA ---
    const token = localStorage.getItem('authToken');
    const userDataStr = localStorage.getItem('userData');

    if (!token) {
        alert("Anda belum login! Mengarahkan ke halaman login...");
        window.location.href = "login.html";
    }

    if (userDataStr) {
        try {
            const user = JSON.parse(userDataStr);
            document.getElementById('userNameDisplay').textContent = `Hi, ${user.username || user.name || 'User'}`;
            // Update avatar jika ada (gunakan UI Avatars sebagai fallback)
            const avatarUrl = `https://ui-avatars.com/api/?name=${user.username}&background=random`;
            document.getElementById('userAvatarImg').src = avatarUrl;
        } catch (e) { console.error("Error parsing user data", e); }
    }

    // --- DOM ELEMENTS ---
    const eventContainer = document.getElementById('eventListContainer');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const searchBtn = document.getElementById('searchBtn');

    // --- 1. FETCH CATEGORIES (Untuk Dropdown) ---
    async function fetchCategories() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/categories`, {
                headers: { 'Accept': 'application/json' }
            });
            const result = await response.json();
            
            if (response.ok && result.data && result.data.categories) {
                const categories = result.data.categories;
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Gagal memuat kategori:", error);
        }
    }

    // --- 2. FETCH EVENTS (Data Utama) ---
    async function fetchEvents() {
        const keyword = searchInput.value;
        const categoryId = categorySelect.value;

        eventContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Memuat event...</div>';

        try {
            // Setup URL Parameter
            const params = new URLSearchParams();
            params.append('status', 'published'); // Hanya tampilkan yang published
            if (keyword) params.append('search', keyword);
            if (categoryId) params.append('category_id', categoryId);

            const response = await fetch(`${API_BASE_URL}/api/events?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                handleLogout("Sesi berakhir. Silakan login kembali.");
                return;
            }

            const result = await response.json();
            
            // Handle struktur data (kadang dibungkus 'data', kadang pagination 'data.data')
            let events = [];
            if (result.data && Array.isArray(result.data.data)) {
                events = result.data.data;
            } else if (result.data && Array.isArray(result.data)) {
                events = result.data;
            } else if (Array.isArray(result)) {
                events = result;
            }

            renderEvents(events);

        } catch (error) {
            console.error("Fetch Error:", error);
            eventContainer.innerHTML = `<div class="error-msg">Gagal memuat event. Pastikan server backend menyala.</div>`;
        }
    }

    // --- 3. RENDER EVENTS KE HTML ---
    function renderEvents(events) {
        eventContainer.innerHTML = '';

        if (!events || events.length === 0) {
            eventContainer.innerHTML = '<div class="loading">Tidak ada event ditemukan.</div>';
            return;
        }

        events.forEach(event => {
            // Handle Gambar (Cek apakah URL full atau path local storage)
            let imageUrl = 'https://via.placeholder.com/400x200?text=No+Image';
            if (event.image_url) {
                imageUrl = event.image_url.startsWith('http') 
                    ? event.image_url 
                    : `${API_BASE_URL}${event.image_url}`;
            }

            // Format Tanggal
            const dateStr = new Date(event.start_date).toLocaleDateString('id-ID', {
                day: 'numeric', month: 'short', year: 'numeric'
            });

            // HTML Card Event
            const cardHTML = `
              <div class="event-card">
                <img src="${imageUrl}" alt="${event.title}" onerror="this.src='https://via.placeholder.com/400x200?text=Error+Loading+Image'">
                <div class="event-content">
                  <div class="event-header">
                    <span class="event-category" style="background: #e0f0ff; color: #007bff; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">
                        ${event.category ? event.category.name : 'Umum'}
                    </span>
                    <span class="event-date">${dateStr}</span>
                  </div>
                  <h3>${event.title}</h3>
                  <p>${event.description ? event.description.substring(0, 80) + '...' : '...'}</p>
                  <div class="event-footer">
                    <span class="event-location"><i class="fas fa-map-marker-alt"></i> ${event.location || 'Online'}</span>
                    <a href="detail-event.html?id=${event.id}" class="btn-small">Detail</a>
                  </div>
                </div>
              </div>
            `;
            eventContainer.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    // --- 4. LOGOUT ---
    async function handleLogout(msg = "Logout Berhasil") {
        if (!confirm("Yakin ingin keluar?")) return;

        try {
            await fetch(`${API_BASE_URL}/api/logout`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
        } catch (e) { console.log("Logout error ignored", e); }

        localStorage.clear();
        alert(msg);
        window.location.href = "login.html";
    }

    // --- EVENT LISTENERS ---
    searchBtn.addEventListener('click', fetchEvents);
    
    // Cari saat tekan Enter
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') fetchEvents();
    });

    // Cari otomatis saat ganti kategori
    categorySelect.addEventListener('change', fetchEvents);

    // --- JALANKAN SAAT LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchCategories(); // Isi dropdown dulu
        fetchEvents();     // Load event list
    });
  </script>
</body>
</html>
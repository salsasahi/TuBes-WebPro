<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EventHub - Profile</title>
    <link rel="stylesheet" href="profilnew.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        /* CSS Tambahan untuk Loading State */
        .loading-state {
            text-align: center;
            padding: 20px;
            color: #666;
            width: 100%;
        }
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #888;
            font-style: italic;
            width: 100%;
        }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <a href="dashboard_new.html" class="logo">
           <div class="logo-icon">
              <img src="logoEvent.jpg" alt="EventKu" onerror="this.style.display='none'"/> 
              <h1 class="logo-text">EventKu</h1>
            </div>
          </a>
        </div>
      </div>
      <div class="header-right">
        <button class="icon-btn">
          <i class="fas fa-bell"></i>
        </button>
        <div class="user-avatar-container">
          <div class="user-avatar" id="userAvatar">
            <img
              src="https://ui-avatars.com/api/?name=User&background=random"
              alt="User"
              id="userAvatarImg"
            />
          </div>
          <div class="logout-popup" id="logoutPopup">
            <button class="logout-btn" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <section class="welcome-section">
        <h1 class="welcome-title" id="welcomeText">Welcome back!</h1>
        <p class="welcome-subtitle">
          Manage your events and discover new opportunities
        </p>
      </section>

      <section class="summary-cards">
        <div class="summary-card">
          <div class="summary-icon blue">
            <i class="fas fa-calendar"></i>
          </div>
          <div class="summary-content">
            <p class="summary-label">Total Events</p>
            <h2 class="summary-number" id="statTotal">0</h2>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon green">
            <i class="fas fa-clock"></i>
          </div>
          <div class="summary-content">
            <p class="summary-label">Upcoming</p>
            <h2 class="summary-number" id="statUpcoming">0</h2>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon purple">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="summary-content">
            <p class="summary-label">Completed</p>
            <h2 class="summary-number" id="statCompleted">0</h2>
          </div>
        </div>
      </section>

      <section class="search-filter-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search my events..." id="searchInput" />
        </div>
        </section>

      <div class="events-container">
        <section id="my-events" class="my-events-section">
          <div class="section-header">
            <h2 class="section-title">My Events</h2>
            <div class="tabs">
              <button class="tab-btn active" data-tab="all">All</button>
              <button class="tab-btn" data-tab="upcoming">Upcoming</button>
              <button class="tab-btn" data-tab="past">Past</button>
            </div>
          </div>

          <div class="events-list" id="myEventsList">
             <div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Memuat history event...</div>
          </div>
        </section>

        <section class="recommended-section">
          <h2 class="section-title">Event Terbaru</h2>
          <div class="recommended-list" id="recommendedList">
             <div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Memuat rekomendasi...</div>
          </div>
        </section>
      </div>
    </main>

    <script>
      // --- KONFIGURASI API ---
      const API_BASE_URL = 'http://127.0.0.1:8000';
      const token = localStorage.getItem('authToken');
      const userDataStr = localStorage.getItem('userData');
      
      // Global variables untuk menyimpan data agar tidak perlu fetch ulang saat ganti tab
      let allMyBookings = []; 

      // --- CEK LOGIN & USER DATA ---
      if (!token) {
        alert("Anda belum login.");
        window.location.href = "login.html";
      }

      if (userDataStr) {
          try {
              const user = JSON.parse(userDataStr);
              // Update Nama di Welcome Header
              document.getElementById('welcomeText').textContent = `Welcome back, ${user.username || 'User'}!`;
              // Update Avatar dengan inisial
              const avatarUrl = `https://ui-avatars.com/api/?name=${user.username || 'User'}&background=0D8ABC&color=fff`;
              const avatarImg = document.getElementById('userAvatarImg');
              if(avatarImg) avatarImg.src = avatarUrl;
          } catch (e) { console.error(e); }
      }

      // --- 1. FETCH MY BOOKINGS (API: /api/my-bookings) ---
      async function fetchMyBookings() {
          const container = document.getElementById('myEventsList');
          
          try {
              const response = await fetch(`${API_BASE_URL}/api/my-bookings`, {
                  method: 'GET',
                  headers: {
                      'Accept': 'application/json',
                      'Authorization': `Bearer ${token}`
                  }
              });

              if (response.status === 401) {
                  handleLogout("Sesi berakhir.");
                  return;
              }

              const result = await response.json();
              
              // Normalisasi data (handle structure {data: []} atau [])
              let bookings = [];
              if (result.data && Array.isArray(result.data)) bookings = result.data;
              else if (Array.isArray(result)) bookings = result;

              allMyBookings = bookings; // Simpan di global var untuk filtering tab
              
              calculateStats(bookings); // Hitung statistik
              renderMyEvents(bookings); // Render ke HTML

          } catch (error) {
              console.error("Error fetching bookings:", error);
              container.innerHTML = `<div class="empty-state">Gagal memuat data event saya.</div>`;
          }
      }

      // --- 2. CALCULATE STATS ---
      function calculateStats(bookings) {
          const now = new Date();
          let upcoming = 0;
          let completed = 0;

          bookings.forEach(booking => {
              // Asumsi structure: booking.event.start_date
              // Jika booking langsung berisi data event, sesuaikan path-nya
              const eventDate = booking.event ? new Date(booking.event.start_date) : new Date();
              
              if (eventDate >= now) {
                  upcoming++;
              } else {
                  completed++;
              }
          });

          // Update UI
          document.getElementById('statTotal').innerText = bookings.length;
          document.getElementById('statUpcoming').innerText = upcoming;
          document.getElementById('statCompleted').innerText = completed;
      }

      // --- 3. RENDER MY EVENTS ---
      function renderMyEvents(bookings) {
          const container = document.getElementById('myEventsList');
          container.innerHTML = '';

          if (bookings.length === 0) {
              container.innerHTML = `<div class="empty-state">Anda belum mengikuti event apapun.</div>`;
              return;
          }

          bookings.forEach(booking => {
              // Extract data event dari booking object
              // Struktur tergantung backend, biasanya { id:..., event: { ... } } atau flat
              const event = booking.event || booking; 
              
              const title = event.title || 'No Title';
              const dateObj = new Date(event.start_date);
              
              // Format Tanggal: MAR 15
              const month = dateObj.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
              const day = dateObj.toLocaleDateString('en-US', { day: 'numeric' });
              
              // Format Waktu
              const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              const location = event.location || 'Online';
              
              // Tentukan status badge logic
              const now = new Date();
              let statusClass = 'registered';
              let statusText = 'Registered';
              
              if (dateObj < now) {
                  statusClass = 'completed';
                  statusText = 'Completed';
              }

              // Warna icon kalender (random/conditional)
              const colors = ['blue', 'purple', 'green'];
              const colorClass = colors[event.id % 3] || 'blue';

              const cardHTML = `
                <div class="event-card">
                  <div class="event-date ${colorClass}">
                    <span class="date-month">${month}</span>
                    <span class="date-day">${day}</span>
                  </div>
                  <div class="event-content">
                    <h3 class="event-title">${title}</h3>
                    <p class="event-description">${event.description ? event.description.substring(0, 60) + '...' : ''}</p>
                    <div class="event-details">
                      <span class="detail-item">
                        <i class="fas fa-clock"></i> ${timeStr}
                      </span>
                      <span class="detail-item">
                        <i class="fas fa-map-marker-alt"></i> ${location}
                      </span>
                    </div>
                    <div class="event-footer">
                      <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                  </div>
                </div>
              `;
              container.insertAdjacentHTML('beforeend', cardHTML);
          });
      }

      // --- 4. FETCH RECOMMENDED EVENTS (API: /api/events) ---
      async function fetchRecommendedEvents() {
          const container = document.getElementById('recommendedList');
          try {
              // Ambil 3 event terbaru
              const response = await fetch(`${API_BASE_URL}/api/events?per_page=3&status=published`, {
                  method: 'GET',
                  headers: {
                      'Accept': 'application/json',
                      'Authorization': `Bearer ${token}`
                  }
              });
              
              const result = await response.json();
              
              // Handle variasi struktur data
              let events = [];
              if (result.data && Array.isArray(result.data)) events = result.data;
              else if (result.data && result.data.data) events = result.data.data; // Paginated
              else if (Array.isArray(result)) events = result;

              renderRecommended(events);

          } catch (error) {
              console.error("Error fetching recommended:", error);
              container.innerHTML = `<div class="empty-state">Gagal memuat rekomendasi.</div>`;
          }
      }

      function renderRecommended(events) {
          const container = document.getElementById('recommendedList');
          container.innerHTML = '';

          if(events.length === 0) {
              container.innerHTML = '<div class="empty-state">Tidak ada event baru.</div>';
              return;
          }

          events.forEach(event => {
              // Gambar
              let imgUrl = 'https://via.placeholder.com/400x250?text=Event';
              if (event.image_url) {
                   imgUrl = event.image_url.startsWith('http') 
                   ? event.image_url 
                   : `${API_BASE_URL}${event.image_url}`;
              }

              const dateStr = new Date(event.start_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric'});
              const loc = event.location || 'Online';

              const html = `
                <div class="recommended-card">
                  <div class="recommended-image">
                    <img src="${imgUrl}" alt="${event.title}" onerror="this.src='https://via.placeholder.com/400x250?text=No+Image'"/>
                  </div>
                  <div class="recommended-content">
                    <h3 class="recommended-title">${event.title}</h3>
                    <p class="recommended-details">${dateStr} â€¢ ${loc}</p>
                    <a href="detail-event.html?id=${event.id}" class="register-btn" style="text-decoration:none; text-align:center; display:inline-block;">View Details</a>
                  </div>
                </div>
              `;
              container.insertAdjacentHTML('beforeend', html);
          });
      }

      // --- 5. LOGOUT FUNCTION ---
      async function handleLogout(msg = "Logout berhasil.") {
          try {
              await fetch(`${API_BASE_URL}/api/logout`, {
                  method: 'POST',
                  headers: { 'Authorization': `Bearer ${token}` }
              });
          } catch(e) { console.log("Logout error", e); }
          
          localStorage.clear();
          alert(msg);
          window.location.href = "login.html";
      }

      // --- EVENT LISTENERS UI ---
      
      // Tab Navigation (All, Upcoming, Past)
      const tabButtons = document.querySelectorAll(".tab-btn");
      tabButtons.forEach(btn => {
          btn.addEventListener("click", () => {
              // Update visual tab active
              tabButtons.forEach(b => b.classList.remove("active"));
              btn.classList.add("active");

              const tab = btn.dataset.tab; // 'all', 'upcoming', 'past'
              const now = new Date();
              
              // Filter data global 'allMyBookings'
              let filtered = [];
              if (tab === 'all') {
                  filtered = allMyBookings;
              } else if (tab === 'upcoming') {
                  filtered = allMyBookings.filter(b => {
                      const d = b.event ? new Date(b.event.start_date) : new Date();
                      return d >= now;
                  });
              } else if (tab === 'past') {
                  filtered = allMyBookings.filter(b => {
                      const d = b.event ? new Date(b.event.start_date) : new Date();
                      return d < now;
                  });
              }
              
              renderMyEvents(filtered);
          });
      });

      // Search (Client Side Filter pada My Events)
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", (e) => {
          const keyword = e.target.value.toLowerCase();
          const filtered = allMyBookings.filter(b => {
              const title = (b.event?.title || '').toLowerCase();
              return title.includes(keyword);
          });
          renderMyEvents(filtered);
      });

      // Logout UI logic
      const userAvatar = document.getElementById("userAvatar");
      const logoutPopup = document.getElementById("logoutPopup");
      const logoutBtn = document.getElementById("logoutBtn");

      userAvatar.addEventListener("click", (e) => {
        e.stopPropagation();
        logoutPopup.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!logoutPopup.contains(e.target) && !userAvatar.contains(e.target)) {
          logoutPopup.classList.remove("show");
        }
      });

      logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if(confirm("Yakin ingin logout?")) handleLogout();
      });

      // Init Load
      document.addEventListener('DOMContentLoaded', () => {
          fetchMyBookings();
          fetchRecommendedEvents();
      });

    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detail Event - EventKu</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <link rel="stylesheet" href="detail.css" />

  <style>
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      font-size: 1.2rem;
      color: #666;
    }

    .error-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      color: #dc3545;
      text-align: center;
      padding: 20px;
    }

    .error-container i {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .error-container .btn-back {
      margin-top: 20px;
      padding: 10px 25px;
      background: #4A90E2;
      color: white;
      text-decoration: none;
      border-radius: 25px;
      transition: 0.3s;
    }

    .error-container .btn-back:hover {
      background: #357ABD;
    }

    .tag.status-active {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .tag.status-soldout {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }

    .tag.status-ended {
      background: linear-gradient(135deg, #6c757d, #5a6268);
      color: white;
    }

    .ticket-counter button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.order:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #ccc;
    }

    .booking-loading {
      display: none;
      margin-left: 10px;
    }

    .booking-loading.show {
      display: inline-block;
    }
  </style>

</head>

<body>
  <header class="navbar">
    <div class="nav-left">
      <a href="dashboard_new.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> Detail Event
      </a>
    </div>
    <div class="nav-right">
      <a href="dashboard_new.html">Dashboard</a>
      <a href="dashboard_new.html#events">Events</a>
      <a href="profilnew.html#my-events">My Events</a>
    </div>
  </header>

  <main class="event-container" id="mainContainer">
    <!-- Loading State -->
    <div class="loading-container" id="loadingState">
      <i class="fas fa-spinner fa-spin"></i>&nbsp; Memuat detail event...
    </div>

    <!-- Error State -->
    <div class="error-container" id="errorState" style="display: none;">
      <i class="fas fa-exclamation-triangle"></i>
      <h2>Gagal Memuat Event</h2>
      <p id="errorMessage">Terjadi kesalahan saat memuat data event.</p>
      <a href="dashboard_new.html" class="btn-back">Kembali ke Dashboard</a>
    </div>

    <!-- Event Content (Hidden until loaded) -->
    <div id="eventContent" style="display: none;">
      <div class="event-banner">
        <img id="eventBanner" src="https://via.placeholder.com/800x400?text=Event+Banner" alt="Event Banner" />
      </div>

      <div class="event-detail-card">
        <div class="event-tags">
          <span class="tag blue" id="categoryTag">Kategori</span>
          <span class="tag" id="statusTag">Status</span>
        </div>

        <h1 class="event-title" id="eventTitle">Nama Event</h1>
        <p class="event-subtitle" id="eventDescription">
          Deskripsi event akan ditampilkan di sini...
        </p>

        <div class="event-details-grid">
          <div class="details-left">
            <div class="info-block">
              <i class="far fa-calendar-alt"></i>
              <div>
                <h4>Date & Time</h4>
                <p id="eventDateTime">Loading...</p>
              </div>
            </div>

            <div class="info-block">
              <i class="fas fa-map-marker-alt"></i>
              <div>
                <h4>Location</h4>
                <p id="eventLocation">Loading...</p>
              </div>
            </div>

            <div class="info-block">
              <i class="fas fa-users"></i>
              <div>
                <h4>Participants</h4>
                <p id="eventParticipants">0 / 0 registered</p>
                <div class="participant-bar">
                  <div class="participant-progress" id="participantProgress"></div>
                </div>
              </div>
            </div>

          </div>

          <div class="details-right">
            <div class="event-organizer">
              <h3>Event Organizer</h3>
              <p><strong id="organizerName">Organizer</strong></p>
              <p><i class="fas fa-envelope"></i> <span id="organizerEmail">-</span></p>
              <p><i class="fas fa-phone"></i> <span id="organizerPhone">-</span></p>
            </div>
          </div>
        </div>


        <section class="about-event">
          <h3>About This Event</h3>
          <div id="aboutEventContent">
            <p>Deskripsi lengkap event akan ditampilkan di sini...</p>
          </div>
        </section>

        <section class="what-you-get" id="whatYouGetSection" style="display: none;">
          <h3>What You'll Get</h3>
          <div id="whatYouGetContent"></div>
        </section>

        <section class="ticket-quantity" id="ticketSection">
          <h3>Jumlah Tiket</h3>
          <div class="ticket-item">
            <div class="ticket-info">
              <strong>Pax</strong>
              <span id="ticketPrice">IDR 0/pax</span>
            </div>
            <div class="ticket-counter">
              <button class="counter-btn" id="decrease" aria-label="Kurangi tiket">-</button>
              <span id="quantity">1</span>
              <button class="counter-btn" id="increase" aria-label="Tambah tiket">+</button>
            </div>
          </div>
          <p id="availableTicketsInfo" style="font-size: 0.85rem; color: #666; margin-top: 10px;">
            <i class="fas fa-info-circle"></i> Tiket tersedia: <span id="availableCount">0</span>
          </p>
        </section>

        <div class="order-footer">
          <div class="total-price">
            <span id="total-label">Total (1 pax):</span>
            <strong id="total-price">IDR 0</strong>
          </div>
          <button class="btn order" id="pesanBtn">
            Pesan Tiket
            <i class="fas fa-spinner fa-spin booking-loading" id="bookingLoading"></i>
          </button>
        </div>

      </div>
    </div>
  </main>

  <footer>
    © 2024 EventKu. All rights reserved.
  </footer>

  <script>
    // ==================================================
    // KONFIGURASI API
    // ==================================================
    const API_BASE_URL = 'http://127.0.0.1:8000';

    // ==================================================
    // CEK AUTENTIKASI
    // ==================================================
    const token = localStorage.getItem('authToken');
    const userDataStr = localStorage.getItem('userData');

    if (!token) {
      alert("Sesi habis atau belum login. Silakan login kembali.");
      window.location.href = "login.html";
    }

    let userData = null;
    if (userDataStr) {
      try {
        userData = JSON.parse(userDataStr);
      } catch (e) {
        console.error("Gagal parsing data user", e);
      }
    }

    // ==================================================
    // AMBIL EVENT ID DARI URL
    // ==================================================
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    if (!eventId) {
      showError("ID Event tidak ditemukan. Silakan pilih event dari halaman dashboard.");
    }

    // ==================================================
    // VARIABEL GLOBAL
    // ==================================================
    let eventData = null;
    let basePrice = 0;
    let quantity = 1;
    let availableTickets = 0;

    // ==================================================
    // ELEMEN DOM
    // ==================================================
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const eventContent = document.getElementById('eventContent');
    const errorMessage = document.getElementById('errorMessage');

    // ==================================================
    // FUNGSI FETCH DETAIL EVENT
    // Endpoint: GET /api/events/{id}
    // ==================================================
    async function fetchEventDetail() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/events/${eventId}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        // Handle unauthorized
        if (response.status === 401) {
          localStorage.clear();
          alert("Sesi Anda telah berakhir. Silakan login kembali.");
          window.location.href = "login.html";
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP Error: ${response.status}`);
        }

        const result = await response.json();
        console.log("Event Detail Response:", result);

        if (result.success && result.data) {
          eventData = result.data;
          renderEventDetail(eventData);
        } else {
          throw new Error(result.message || "Gagal memuat data event");
        }

      } catch (error) {
        console.error("Fetch Event Detail Error:", error);
        showError(error.message);
      }
    }

    // ==================================================
    // FUNGSI RENDER DETAIL EVENT
    // ==================================================
    function renderEventDetail(event) {
      // Hide loading, show content
      loadingState.style.display = 'none';
      eventContent.style.display = 'block';

      // Update page title
      document.title = `Detail Event - ${event.title}`;

      // Banner Image
      const bannerImg = document.getElementById('eventBanner');
      if (event.image_url) {
        bannerImg.src = event.image_url.startsWith('http')
          ? event.image_url
          : `${API_BASE_URL}${event.image_url}`;
      }
      bannerImg.alt = event.title;
      bannerImg.onerror = function () {
        this.src = 'https://via.placeholder.com/800x400?text=No+Image';
      };

      // Category Tag
      const categoryTag = document.getElementById('categoryTag');
      if (event.category) {
        categoryTag.innerHTML = `<i class="fas ${event.category.icon || 'fa-tag'}"></i> ${event.category.name}`;
      }

      // Status Tag
      const statusTag = document.getElementById('statusTag');
      const displayStatus = event.display_status || event.status;
      statusTag.textContent = displayStatus;

      if (displayStatus === 'Active' || event.status === 'published') {
        statusTag.className = 'tag status-active';
      } else if (displayStatus === 'Sold Out' || event.available_tickets === 0) {
        statusTag.className = 'tag status-soldout';
      } else {
        statusTag.className = 'tag status-ended';
      }

      // Title & Description
      document.getElementById('eventTitle').textContent = event.title;
      document.getElementById('eventDescription').textContent = event.description || 'Tidak ada deskripsi.';

      // Date & Time
      const dateTimeEl = document.getElementById('eventDateTime');
      const startDate = formatDate(event.start_date);
      const endDate = formatDate(event.end_date);
      const startTime = formatTime(event.start_date);
      const endTime = formatTime(event.end_date);
      dateTimeEl.innerHTML = `${startDate} <br>${startTime} – ${endTime}`;

      // Location
      const locationEl = document.getElementById('eventLocation');
      const location = event.location || 'Online';
      const address = event.address || '';
      locationEl.innerHTML = address ? `${location}<br>${address}` : location;

      // Participants
      const participantsEl = document.getElementById('eventParticipants');
      const currentParticipants = event.current_participants || 0;
      const maxParticipants = event.max_participants || 0;
      availableTickets = event.available_tickets || 0;

      participantsEl.textContent = `${currentParticipants} / ${maxParticipants} registered`;

      // Progress bar
      const progressEl = document.getElementById('participantProgress');
      const progressPercent = maxParticipants > 0 ? (currentParticipants / maxParticipants) * 100 : 0;
      progressEl.style.width = `${progressPercent}%`;

      // Available tickets info
      document.getElementById('availableCount').textContent = availableTickets;

      // Organizer
      if (event.organizer) {
        document.getElementById('organizerName').textContent = event.organizer.username || 'Organizer';
        document.getElementById('organizerEmail').textContent = event.organizer.email || '-';
        document.getElementById('organizerPhone').textContent = event.organizer.phone || '-';
      }

      // About Event
      const aboutContent = document.getElementById('aboutEventContent');
      aboutContent.innerHTML = `<p>${event.description || 'Tidak ada deskripsi lengkap.'}</p>`;

      // What You'll Get (jika ada)
      const whatYouGetSection = document.getElementById('whatYouGetSection');
      const whatYouGetContent = document.getElementById('whatYouGetContent');

      if (event.what_you_will_get) {
        whatYouGetSection.style.display = 'block';
        // Bisa berupa string atau array
        if (Array.isArray(event.what_you_will_get)) {
          whatYouGetContent.innerHTML = '<ul>' +
            event.what_you_will_get.map(item => `<li>${item}</li>`).join('') +
            '</ul>';
        } else {
          whatYouGetContent.innerHTML = `<p>${event.what_you_will_get}</p>`;
        }
      }

      // Price
      basePrice = parseFloat(event.price) || 0;
      document.getElementById('ticketPrice').textContent = `IDR ${formatCurrency(basePrice)}/pax`;

      // Check if tickets available
      if (availableTickets <= 0) {
        document.getElementById('ticketSection').innerHTML = `
          <h3>Jumlah Tiket</h3>
          <div class="error-msg" style="padding: 20px; text-align: center; color: #dc3545;">
            <i class="fas fa-ticket-alt"></i> Maaf, tiket sudah habis terjual.
          </div>
        `;
        document.getElementById('pesanBtn').disabled = true;
        document.getElementById('pesanBtn').textContent = 'Tiket Habis';
      }

      // Update total harga
      updateBill();
    }

    // ==================================================
    // FUNGSI FORMAT TANGGAL & WAKTU
    // ==================================================
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('id-ID', options);
      } catch (e) {
        return dateString;
      }
    }

    function formatTime(dateString) {
      if (!dateString) return '-';
      try {
        const options = { hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleTimeString('id-ID', options);
      } catch (e) {
        return dateString;
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID').format(amount);
    }

    // ==================================================
    // FUNGSI UPDATE BILL
    // ==================================================
    function updateBill() {
      const quantityEl = document.getElementById('quantity');
      const totalLabelEl = document.getElementById('total-label');
      const totalPriceEl = document.getElementById('total-price');

      quantityEl.textContent = quantity;

      const total = basePrice * quantity;
      totalPriceEl.textContent = `IDR ${formatCurrency(total)}`;
      totalLabelEl.textContent = `Total (${quantity} pax):`;

      // Update button states
      const decreaseBtn = document.getElementById('decrease');
      const increaseBtn = document.getElementById('increase');

      if (decreaseBtn) decreaseBtn.disabled = quantity <= 1;
      if (increaseBtn) increaseBtn.disabled = quantity >= availableTickets;
    }

    // ==================================================
    // FUNGSI SHOW ERROR
    // ==================================================
    function showError(message) {
      loadingState.style.display = 'none';
      eventContent.style.display = 'none';
      errorState.style.display = 'flex';
      errorMessage.textContent = message;
    }

    // ==================================================
    // FUNGSI BOOKING / PESAN TIKET
    // Endpoint: POST /api/bookings
    // ==================================================
    async function createBooking() {
      const pesanBtn = document.getElementById('pesanBtn');
      const bookingLoading = document.getElementById('bookingLoading');

      // Disable button & show loading
      pesanBtn.disabled = true;
      bookingLoading.classList.add('show');

      try {
        // Siapkan request body untuk booking
        const bookingData = {
          event_id: parseInt(eventId),
          quantity: quantity,
          customer_name: userData?.username || 'Guest',
          customer_email: userData?.email || '',
          customer_phone: userData?.phone || '08123456789',
          gender: 'Laki-Laki' // Default, bisa diubah sesuai kebutuhan
        };

        console.log("Booking Request:", bookingData);

        const response = await fetch(`${API_BASE_URL}/api/bookings`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookingData)
        });

        // Handle unauthorized
        if (response.status === 401) {
          localStorage.clear();
          alert("Sesi Anda telah berakhir. Silakan login kembali.");
          window.location.href = "login.html";
          return;
        }

        const result = await response.json();
        console.log("Booking Response:", result);

        if (response.ok && result.data) {
          // Simpan data booking ke localStorage untuk halaman selanjutnya
          const orderData = {
            bookingId: result.data.id,
            bookingCode: result.data.booking_id,
            eventId: eventId,
            eventName: eventData.title,
            quantity: quantity,
            pricePerTicket: basePrice,
            totalPrice: basePrice * quantity,
            grandTotal: result.data.pricing?.grand_total || (basePrice * quantity),
            serviceFee: result.data.pricing?.service_fee || 0,
            location: eventData.location,
            address: eventData.address,
            startDate: eventData.start_date,
            endDate: eventData.end_date,
            status: result.data.status,
            payLink: result.links?.pay || `/api/bookings/${result.data.id}/pay`
          };

          localStorage.setItem('orderData', JSON.stringify(orderData));

          alert(`Booking berhasil dibuat!\nKode Booking: ${result.data.booking_id}\nTotal: IDR ${formatCurrency(orderData.grandTotal)}`);

          // Redirect ke halaman konfirmasi/pembayaran
          window.location.href = 'detail2.html';

        } else {
          // Handle error dari server
          const errorMsg = result.message || result.error || 'Gagal membuat booking';
          alert(`Error: ${errorMsg}`);
        }

      } catch (error) {
        console.error("Booking Error:", error);
        alert(`Terjadi kesalahan: ${error.message}`);
      } finally {
        // Re-enable button & hide loading
        pesanBtn.disabled = false;
        bookingLoading.classList.remove('show');
      }
    }

    // ==================================================
    // EVENT LISTENERS
    // ==================================================
    document.addEventListener('DOMContentLoaded', function () {
      // Fetch event detail saat page load
      if (eventId) {
        fetchEventDetail();
      }

      // Tombol + untuk tambah quantity
      document.getElementById('increase').addEventListener('click', function () {
        if (quantity < availableTickets) {
          quantity++;
          updateBill();
        }
      });

      // Tombol - untuk kurangi quantity
      document.getElementById('decrease').addEventListener('click', function () {
        if (quantity > 1) {
          quantity--;
          updateBill();
        }
      });

      // Tombol Pesan
      document.getElementById('pesanBtn').addEventListener('click', function () {
        if (availableTickets <= 0) {
          alert('Maaf, tiket sudah habis terjual.');
          return;
        }

        if (confirm(`Konfirmasi pemesanan:\n\nEvent: ${eventData.title}\nJumlah: ${quantity} tiket\nTotal: IDR ${formatCurrency(basePrice * quantity)}\n\nLanjutkan?`)) {
          createBooking();
        }
      });
    });
  </script>

</body>

</html>